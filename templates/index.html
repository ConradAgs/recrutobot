<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecrutoBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .offer-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #4b8bbe;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .offer-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 8px;
            cursor: pointer;
            text-decoration: none;
        }
        .offer-title:hover {
            text-decoration: underline;
            color: #0d3c6e;
        }
        .offer-description {
            font-size: 0.9em;
            color: #444444;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .offer-score {
            font-size: 0.8em;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }
        .offer-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.85em;
        }
        .offer-detail {
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
        }
        .offer-detail-icon {
            margin-right: 4px;
        }
        .pagination-info {
            font-size: 0.9em;
            color: #6c757d;
            text-align: center;
            margin: 10px 0;
        }
        .chat-message {
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            max-width: 80%;
        }
        .user-message {
            background-color: #e6f7ff;
            margin-left: auto;
        }
        .assistant-message {
            background-color: #f0f0f0;
            margin-right: auto;
        }
        .results-message {
            background-color: #f8f9fa;
            margin-right: auto;
            width: 100%;
            max-width: 100%;
        }
        #chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <header class="bg-white shadow-sm py-4 px-6">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold text-blue-800">üíº RecrutoBot</h1>
            <p class="text-gray-600">Version 100% locale sans API externe</p>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6 max-w-6xl flex flex-col">
        <!-- Zone de chat -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-4 flex-grow flex flex-col">
            <div id="chat-container" class="flex-grow overflow-y-auto p-4 bg-gray-50 rounded-lg mb-4">
                <div class="chat-message assistant-message">
                    Bonjour ! Je suis votre assistant pour la recherche d'emploi. Comment puis-je vous aider ?
                </div>
            </div>

            <!-- Formulaire de recherche -->
            <form id="search-form" class="flex gap-2">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Ex: 'D√©veloppeur Python junior √† Paris'" 
                    class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                >
                <button 
                    type="submit" 
                    id="search-button"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    Rechercher
                </button>
            </form>
        </div>

        <!-- R√©sultats de recherche (cach√© par d√©faut) -->
        <div id="results-container" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold mb-4" id="results-title"></h2>
            <div id="offers-container"></div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-6">
                <div class="pagination-info" id="pagination-info"></div>
                <div class="flex gap-2">
                    <button id="first-page" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">‚è™ Premi√®re</button>
                    <button id="prev-page" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">‚óÄÔ∏è Pr√©c√©dente</button>
                    <button id="next-page" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Suivante ‚ñ∂Ô∏è</button>
                    <button id="last-page" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">Derni√®re ‚è©</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Variables globales
        let currentResults = [];
        let currentPage = 0;
        let chatHistory = [
            { role: "assistant", content: "Bonjour ! Je suis votre assistant pour la recherche d'emploi. Comment puis-je vous aider ?" }
        ];
        const resultsPerPage = 5;

        // √âl√©ments DOM
        const chatContainer = document.getElementById('chat-container');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results-container');
        const resultsTitle = document.getElementById('results-title');
        const offersContainer = document.getElementById('offers-container');
        const paginationInfo = document.getElementById('pagination-info');
        const firstPageBtn = document.getElementById('first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');

        // Ajouter un message au chat
        function addMessage(content, isUser = false, isResults = false) {
            const messageDiv = document.createElement('div');
            
            if (isResults) {
                messageDiv.className = 'chat-message results-message';
                messageDiv.innerHTML = content;
            } else {
                messageDiv.className = isUser ? 'chat-message user-message' : 'chat-message assistant-message';
                messageDiv.textContent = content;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Ajouter √† l'historique
            if (!isResults) {
                chatHistory.push({
                    role: isUser ? "user" : "assistant",
                    content: content
                });
            }
        }

        // Formater les d√©tails de l'offre
        function formatOfferDetails(offer) {
            let detailsHTML = '<div class="offer-details">';
            
            // Localisation
            if (offer.lieuTravail && offer.lieuTravail.libelle) {
                const location = offer.lieuTravail.libelle.replace(/^\d+\s*-\s*/, ''); // Enlever le code d√©partement
                detailsHTML += `
                    <div class="offer-detail">
                        <span class="offer-detail-icon">üìç</span>
                        ${location}
                    </div>
                `;
            }
            
            // Type de contrat
            if (offer.typeContratLibelle) {
                detailsHTML += `
                    <div class="offer-detail">
                        <span class="offer-detail-icon">üìÑ</span>
                        ${offer.typeContratLibelle}
                    </div>
                `;
            } else if (offer.typeContrat) {
                detailsHTML += `
                    <div class="offer-detail">
                        <span class="offer-detail-icon">üìÑ</span>
                        ${offer.typeContrat}
                    </div>
                `;
            }
            
            // Exp√©rience requise
            if (offer.experienceLibelle && offer.experienceLibelle !== "Non pr√©cis√©") {
                detailsHTML += `
                    <div class="offer-detail">
                        <span class="offer-detail-icon">üéØ</span>
                        ${offer.experienceLibelle}
                    </div>
                `;
            }
            
            // Salaire
            if (offer.salaire && offer.salaire.libelle) {
                detailsHTML += `
                    <div class="offer-detail">
                        <span class="offer-detail-icon">üí∞</span>
                        ${offer.salaire.libelle}
                    </div>
                `;
            }
            
            // Entreprise
            if (offer.entreprise && offer.entreprise.nom) {
                detailsHTML += `
                    <div class="offer-detail">
                        <span class="offer-detail-icon">üè¢</span>
                        ${offer.entreprise.nom}
                    </div>
                `;
            }
            
            detailsHTML += '</div>';
            return detailsHTML;
        }

        // Afficher les offres dans le chat
        function displayOffersInChat() {
            if (currentResults.length === 0) {
                return;
            }

            const totalPages = Math.ceil(currentResults.length / resultsPerPage);
            const startIdx = currentPage * resultsPerPage;
            const endIdx = Math.min((currentPage + 1) * resultsPerPage, currentResults.length);

            // Cr√©er le contenu HTML pour les r√©sultats
            let resultsHTML = `<h3 class="text-lg font-semibold mb-3">üìã R√©sultats ${startIdx + 1}-${endIdx} sur ${currentResults.length}</h3>`;
            
            for (let i = startIdx; i < endIdx; i++) {
                const offer = currentResults[i];
                
                // URL de l'offre (si disponible)
                const offerUrl = offer.origineOffre && offer.origineOffre.urlOrigine 
                    ? offer.origineOffre.urlOrigine 
                    : `https://candidat.francetravail.fr/offres/recherche/detail/${offer.id}`;
                
                // Formater les d√©tails de l'offre
                const detailsHTML = formatOfferDetails(offer);
                
                resultsHTML += `
                    <div class="offer-card">
                        <a href="${offerUrl}" target="_blank" class="offer-title">
                            ${offer.intitule}
                        </a>
                        ${detailsHTML}
                        <div class="offer-description">${offer.description.substring(0, 250)}...</div>
                        <div class="offer-score">Pertinence: ${offer.score.toFixed(3)}</div>
                    </div>
                `;
            }
            
            // Ajouter la pagination
            resultsHTML += `
                <div class="flex justify-between items-center mt-4">
                    <div class="pagination-info">Page ${currentPage + 1} sur ${totalPages}</div>
                    <div class="flex gap-2">
                        <button onclick="changePage(0)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 ${currentPage === 0 ? 'opacity-50' : ''}">‚è™ Premi√®re</button>
                        <button onclick="changePage(${currentPage - 1})" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 ${currentPage === 0 ? 'opacity-50' : ''}">‚óÄÔ∏è Pr√©c√©dente</button>
                        <button onclick="changePage(${currentPage + 1})" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 ${currentPage >= totalPages - 1 ? 'opacity-50' : ''}">Suivante ‚ñ∂Ô∏è</button>
                        <button onclick="changePage(${totalPages - 1})" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 ${currentPage >= totalPages - 1 ? 'opacity-50' : ''}">Derni√®re ‚è©</button>
                    </div>
                </div>
            `;
            
            // Ajouter les r√©sultats au chat
            addMessage(resultsHTML, false, true);
        }

        // Changer de page
        function changePage(page) {
            const totalPages = Math.ceil(currentResults.length / resultsPerPage);
            
            if (page < 0) page = 0;
            if (page >= totalPages) page = totalPages - 1;
            
            currentPage = page;
            
            // Supprimer l'ancien message de r√©sultats
            const resultsMessages = document.querySelectorAll('.results-message');
            if (resultsMessages.length > 0) {
                resultsMessages[resultsMessages.length - 1].remove();
            }
            
            // Afficher les nouveaux r√©sultats
            displayOffersInChat();
        }

        // Exposer la fonction changePage globalement pour les boutons
        window.changePage = changePage;

        // G√©rer la soumission du formulaire
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const prompt = searchInput.value.trim();
            if (!prompt) return;
            
            // D√©sactiver le bouton pendant la recherche
            searchButton.disabled = true;
            searchButton.textContent = 'Recherche...';
            
            // Ajouter le message de l'utilisateur
            addMessage(prompt, true);
            searchInput.value = '';
            
            try {
                // Envoyer la requ√™te au serveur
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Ajouter la r√©ponse de l'assistant
                addMessage(data.message);
                
                // Afficher les r√©sultats dans le chat
                if (data.results && data.results.length > 0) {
                    currentResults = data.results;
                    currentPage = 0;
                    displayOffersInChat();
                }
                
                // Cacher le conteneur de r√©sultats s√©par√©
                resultsContainer.classList.add('hidden');
            } catch (error) {
                console.error('Erreur lors de la recherche:', error);
                addMessage('D√©sol√©, une erreur s\'est produite lors de la recherche. Veuillez r√©essayer.');
            } finally {
                // R√©activer le bouton
                searchButton.disabled = false;
                searchButton.textContent = 'Rechercher';
            }
        });

        // Focus sur le champ de recherche au chargement
        window.addEventListener('load', () => {
            searchInput.focus();
        });
    </script>
</body>
</html>